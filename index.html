<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi 7J - Offline Resilient</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <nav class="bg-blue-700 p-4 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="layout-list" class="w-6 h-6"></i>
                <span class="font-bold text-lg">Absensi 7J</span>
            </div>
            <button id="btnToggleView" class="text-xs bg-white/20 px-4 py-2 rounded-full font-medium hover:bg-white/30 transition">
                Riwayat
            </button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4">
        <div id="viewGrid" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-slate-800">Status Kehadiran</h2>
                    <p id="statusLabel" class="text-[10px] font-medium uppercase tracking-wider"></p>
                </div>
                <div class="text-right">
                    <span id="counter" class="text-2xl font-black text-blue-600">0</span>
                    <span class="text-slate-400 font-bold">/34</span>
                </div>
            </div>
            <div id="studentContainer" class="grid grid-cols-4 sm:grid-cols-6 gap-3"></div>
        </div>

        <div id="viewDetail" class="hidden">
            <button onclick="ui.show('grid')" class="flex items-center gap-1 text-slate-500 mb-4 font-semibold text-sm">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
            </button>
            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="bg-blue-700 p-8 text-center text-white">
                    <h2 id="detNama" class="text-2xl font-bold">-</h2>
                    <p id="detInfo" class="text-blue-100 text-sm"></p>
                </div>
                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="ui.setStatus('Masuk')" id="stMasuk" class="btn-st p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="check-circle"></i> MASUK
                        </button>
                        <button onclick="ui.setStatus('Izin')" id="stIzin" class="btn-st p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="clock"></i> IZIN
                        </button>
                        <button onclick="ui.setStatus('Sakit')" id="stSakit" class="btn-st p-4 rounded-2xl border-2 flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="x-circle"></i> SAKIT
                        </button>
                    </div>
                    <textarea id="reasonInput" placeholder="Catatan (opsional untuk Masuk)..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm h-28 outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    <button id="btnSave" onclick="action.save()" class="w-full bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 disabled:bg-slate-300">
                        <i data-lucide="save" class="w-5 h-5"></i> Simpan Absen
                    </button>
                </div>
            </div>
        </div>

        <div id="viewHistory" class="hidden space-y-4">
            <input type="date" id="filterDate" class="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none">
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <script>
        const db = {
            config: {
                token: "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",
                repo: "sanzkukis-debug/7j-mnj",
                file: "data.json"
            },
            sha: "",
            async load() {
                // Menambahkan timeout agar tidak menunggu terlalu lama jika internet buruk
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                try {
                    const r = await fetch(`https://github.com/sanzkukis-debug/7j-mnj/data.json`, {
                        headers: { Authorization: `token ${this.config.token}` },
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    if (!r.ok) throw new Error("Gagal akses file");
                    const d = await r.json();
                    this.sha = d.sha;
                    return JSON.parse(atob(d.content));
                } catch (e) {
                    clearTimeout(timeoutId);
                    console.warn("GitHub offline, menggunakan mode lokal.");
                    throw e; // Lemparkan error agar ditangani oleh action.refresh
                }
            },
            async push(data, msg) {
                return fetch(`https://api.github.com/repos/${this.config.repo}/contents/${this.config.file}`, {
                    method: "PUT",
                    headers: { Authorization: `token ${this.config.token}` },
                    body: JSON.stringify({ message: msg, content: btoa(JSON.stringify(data, null, 2)), sha: this.sha })
                });
            }
        };

        let attendance = [];
        let selectedId = null;
        let currentStatus = 'Masuk';
        const getToday = () => new Date().toISOString().split('T')[0];

        const action = {
            async refresh() {
                const label = document.getElementById('statusLabel');
                label.innerText = "⏳ Sinkronisasi...";
                label.className = "text-[10px] font-medium text-amber-600 uppercase";

                try {
                    attendance = await db.load();
                    label.innerText = "● Online (GitHub)";
                    label.className = "text-[10px] font-medium text-green-600 uppercase";
                } catch (e) {
                    // JIKA GAGAL, attendance tetap menggunakan data terakhir (atau kosong)
                    label.innerText = "○ Offline Mode";
                    label.className = "text-[10px] font-medium text-red-500 uppercase";
                } finally {
                    // APAPUN YANG TERJADI, renderGrid tetap dijalankan
                    ui.renderGrid();
                    ui.renderHistory();
                }
            },
            async save() {
                const note = document.getElementById('reasonInput').value;
                if (currentStatus !== 'Masuk' && !note) return alert("Alasan wajib diisi!");

                const btn = document.getElementById('btnSave');
                btn.disabled = true;
                btn.innerText = "Mengirim...";

                const entry = {
                    id: selectedId,
                    name: `Siswa ${selectedId}`,
                    status: currentStatus,
                    note: note,
                    date: getToday(),
                    time: new Date().getTime()
                };

                try {
                    const res = await db.push([...attendance, entry], `Absen No ${selectedId}`);
                    if (res.ok) {
                        alert("Berhasil disimpan ke GitHub!");
                        await this.refresh();
                        ui.show('grid');
                    } else {
                        throw new Error();
                    }
                } catch {
                    alert("Gagal terhubung ke GitHub. Cek koneksi atau Token!");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="save" class="w-5 h-5"></i> Simpan Absen`;
                    lucide.createIcons();
                }
            }
        };

        const ui = {
            show(name) {
                ['viewGrid', 'viewDetail', 'viewHistory'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById(`view${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.remove('hidden');
                lucide.createIcons();
            },
            setStatus(s) {
                currentStatus = s;
                document.querySelectorAll('.btn-st').forEach(b => b.className = "btn-st p-4 rounded-2xl border-2 flex flex-col items-center gap-2 border-slate-100 text-slate-400 font-bold text-xs");
                const color = { Masuk: 'green', Izin: 'amber', Sakit: 'red' }[s];
                document.getElementById(`st${s}`).className = `btn-st p-4 rounded-2xl border-2 flex flex-col items-center gap-2 bg-${color}-50 border-${color}-500 text-${color}-700 font-bold text-xs`;
            },
            renderGrid() {
                const container = document.getElementById('studentContainer');
                container.innerHTML = '';
                let count = 0;
                // Render tetap berjalan 1-34 meskipun tidak ada internet
                for (let i = 1; i <= 34; i++) {
                    const done = attendance.find(a => a.id === i && a.date === getToday());
                    if (done) count++;
                    const b = document.createElement('button');
                    b.className = `aspect-square rounded-2xl border-2 flex flex-col items-center justify-center transition-all ${done ? 'bg-green-50 border-green-500 text-green-700' : 'bg-white border-slate-200 text-slate-400'}`;
                    b.innerHTML = `<span class="text-xl font-bold">${i}</span><span class="text-[8px] uppercase font-black">${done ? done.status : 'BELUM'}</span>`;
                    b.onclick = () => {
                        if (done) return alert("Siswa ini sudah diabsen hari ini!");
                        selectedId = i;
                        document.getElementById('detNama').innerText = `Siswa No. ${i}`;
                        document.getElementById('detInfo').innerText = `Tanggal: ${getToday()}`;
                        document.getElementById('reasonInput').value = '';
                        this.setStatus('Masuk');
                        this.show('detail');
                    };
                    container.appendChild(b);
                }
                document.getElementById('counter').innerText = count;
            },
            renderHistory() {
                const list = document.getElementById('historyList');
                const filter = document.getElementById('filterDate').value;
                list.innerHTML = '';
                const data = attendance.filter(a => filter ? a.date === filter : true).sort((a,b) => b.time - a.time);
                if(data.length === 0) {
                    list.innerHTML = `<div class="p-8 text-center text-slate-400 text-sm italic">Tidak ada data riwayat.</div>`;
                    return;
                }
                data.forEach(a => {
                    const d = document.createElement('div');
                    d.className = "bg-white p-4 rounded-xl border border-slate-200 flex gap-3 shadow-sm";
                    d.innerHTML = `<div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-bold">${a.id}</div>
                                   <div><p class="font-bold text-sm text-slate-800">Siswa ${a.id} - ${a.status}</p><p class="text-[10px] text-slate-400">${a.date} | ${a.note || ''}</p></div>`;
                    list.appendChild(d);
                });
            }
        };

        // --- INIT ---
        document.getElementById('btnToggleView').onclick = () => {
            const isGrid = !document.getElementById('viewGrid').classList.contains('hidden');
            ui.show(isGrid ? 'history' : 'grid');
            document.getElementById('btnToggleView').innerText = isGrid ? 'Kembali' : 'Riwayat';
        };
        document.getElementById('filterDate').value = getToday();
        document.getElementById('filterDate').onchange = () => ui.renderHistory();
        
        // Panggil refresh saat start
        action.refresh();
        lucide.createIcons();
    </script>
</body>
</html>
