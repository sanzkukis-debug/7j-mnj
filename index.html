<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Kelas 7J - GitHub Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <nav class="bg-blue-700 p-4 text-white sticky top-0 z-50 shadow-lg">
        <div class="max-w-xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="cloud-zap" class="w-6 h-6"></i>
                <span class="font-bold text-lg">Absensi Kelas 7J</span>
            </div>
            <button id="btnHistory" class="text-xs bg-white/20 px-4 py-2 rounded-full font-medium hover:bg-white/30 transition">
                Riwayat
            </button>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4">
        <div id="viewGrid" class="space-y-4">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-slate-800">Daftar Kehadiran</h2>
                    <p id="currentDateLabel" class="text-xs text-slate-500 italic">Menghubungkan ke GitHub...</p>
                </div>
                <div class="text-right">
                    <span id="counter" class="text-2xl font-black text-blue-600">0</span>
                    <span class="text-slate-400 font-bold">/34</span>
                </div>
            </div>
            <div id="studentContainer" class="grid grid-cols-4 sm:grid-cols-6 gap-3"></div>
        </div>

        <div id="viewDetail" class="hidden">
            <button onclick="showView('grid')" class="flex items-center gap-1 text-slate-500 mb-4 font-semibold text-sm">
                <i data-lucide="chevron-left" class="w-4 h-4"></i> Kembali
            </button>
            <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden">
                <div class="bg-blue-700 p-8 text-center text-white">
                    <h2 id="selectedStudentName" class="text-2xl font-bold"></h2>
                    <p id="selectedStudentInfo" class="text-blue-100 text-sm"></p>
                </div>
                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setStatus('Masuk')" id="btnMasuk" class="status-btn py-4 rounded-2xl border-2 font-bold text-xs flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="check-circle"></i> MASUK
                        </button>
                        <button onclick="setStatus('Izin')" id="btnIzin" class="status-btn py-4 rounded-2xl border-2 font-bold text-xs flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="clock"></i> IZIN
                        </button>
                        <button onclick="setStatus('Sakit')" id="btnSakit" class="status-btn py-4 rounded-2xl border-2 font-bold text-xs flex flex-col items-center gap-2 transition-all">
                            <i data-lucide="x-circle"></i> SAKIT
                        </button>
                    </div>
                    <textarea id="reasonInput" placeholder="Keterangan (Wajib jika Izin/Sakit)..." class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm h-28 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                    <button id="btnSave" class="w-full bg-blue-700 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 disabled:bg-slate-300">
                        <i data-lucide="send" class="w-5 h-5"></i> Simpan ke GitHub
                    </button>
                </div>
            </div>
        </div>

        <div id="viewHistory" class="hidden space-y-4">
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm space-y-3">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-slate-800">Filter Tanggal</h2>
                </div>
                <input type="date" id="filterDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div id="historyList" class="space-y-3"></div>
        </div>
    </main>

    <script>
        const GH_CONFIG = {
            token: "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", 
            owner: "sanzkukis-debug",     
            repo: "7j-mnj",     
            path: "data.json"           
        };

        let attendanceData = [];
        let currentStatus = 'Masuk';
        let currentStudent = null;
        let fileSha = ""; 

        const getRawToday = () => new Date().toISOString().split('T')[0];

        // 1. AMBIL DATA DARI GITHUB (DISETEL AGAR TIDAK ERROR MESKI DATA KOSONG)
        async function fetchData() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`, {
                    headers: { "Authorization": `token ${GH_CONFIG.token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    fileSha = data.sha;
                    attendanceData = JSON.parse(atob(data.content));
                } else {
                    console.warn("File tidak ditemukan atau akses ditolak, menggunakan data kosong.");
                    attendanceData = [];
                }
            } catch (e) {
                console.error("Gagal sinkronisasi:", e);
                attendanceData = [];
            } finally {
                // APAPUN HASILNYA, GRID TETAP HARUS MUNCUL
                renderGrid();
                renderHistory();
            }
        }

        // 2. SIMPAN DATA KE GITHUB
        async function saveToGithub() {
            const reason = document.getElementById('reasonInput').value;
            if(currentStatus !== 'Masuk' && !reason) return alert('Alasan wajib diisi!');
            
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.innerText = "Mengunggah...";

            const newData = {
                studentId: currentStudent,
                studentName: `Siswa Absen ${currentStudent}`,
                status: currentStatus,
                reason: reason,
                date: getRawToday(),
                timestamp: new Date().getTime()
            };

            const updatedData = [...attendanceData, newData];

            try {
                const res = await fetch(`https://api.github.com/repos/${GH_CONFIG.owner}/${GH_CONFIG.repo}/contents/${GH_CONFIG.path}`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${GH_CONFIG.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: `Absen Siswa ${currentStudent} [${getRawToday()}]`,
                        content: btoa(JSON.stringify(updatedData, null, 2)),
                        sha: fileSha
                    })
                });

                if(res.ok) {
                    await fetchData();
                    showView('grid');
                } else {
                    alert("Gagal menyimpan. Pastikan file data.json sudah ada di GitHub.");
                }
            } catch (e) {
                alert("Gagal koneksi ke GitHub!");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="send" class="w-5 h-5"></i> Simpan ke GitHub`;
                lucide.createIcons();
            }
        }

        // --- LOGIKA UI ---

        window.showView = (viewName) => {
            document.querySelectorAll('main > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`).classList.remove('hidden');
            lucide.createIcons();
        };

        window.setStatus = (status) => {
            currentStatus = status;
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.className = "status-btn py-4 rounded-2xl border-2 font-bold text-xs flex flex-col items-center gap-2 border-slate-100 text-slate-400";
            });
            const colors = { 'Masuk': 'green', 'Izin': 'amber', 'Sakit': 'red' };
            const activeBtn = document.getElementById(`btn${status}`);
            activeBtn.className = `status-btn py-4 rounded-2xl border-2 font-bold text-xs flex flex-col items-center gap-2 bg-${colors[status]}-50 border-${colors[status]}-500 text-${colors[status]}-700`;
        };

        window.renderGrid = () => {
            const container = document.getElementById('studentContainer');
            if(!container) return;
            container.innerHTML = '';
            const today = getRawToday();
            let count = 0;

            // Perulangan 1-34 tetap jalan meskipun attendanceData kosong
            for (let i = 1; i <= 34; i++) {
                const record = attendanceData.find(a => a.studentId === i && a.date === today);
                const isDone = !!record;
                if(isDone) count++;

                const btn = document.createElement('button');
                btn.className = `aspect-square rounded-2xl border-2 flex flex-col items-center justify-center transition-all ${isDone ? 'bg-green-50 border-green-500 text-green-700' : 'bg-white border-slate-200 text-slate-600'}`;
                btn.innerHTML = `<span class="text-xl font-black">${i}</span><span class="text-[8px] font-bold uppercase">${isDone ? record.status : 'Belum'}</span>`;
                btn.onclick = () => {
                    if(isDone) return alert('Siswa ini sudah diabsen hari ini!');
                    currentStudent = i;
                    document.getElementById('selectedStudentName').innerText = `Siswa No. ${i}`;
                    document.getElementById('selectedStudentInfo').innerText = `Tanggal: ${today}`;
                    setStatus('Masuk');
                    document.getElementById('reasonInput').value = '';
                    showView('detail');
                };
                container.appendChild(btn);
            }
            document.getElementById('counter').innerText = count;
            document.getElementById('currentDateLabel').innerText = today;
        };

        window.renderHistory = () => {
            const list = document.getElementById('historyList');
            if(!list) return;
            const selectedDate = document.getElementById('filterDate').value;
            list.innerHTML = '';
            
            const filtered = attendanceData
                .filter(a => selectedDate ? a.date === selectedDate : true)
                .sort((a, b) => b.timestamp - a.timestamp);

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">Tidak ada data untuk tanggal ini.</div>`;
                return;
            }

            filtered.forEach(rec => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-3";
                div.innerHTML = `
                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-bold">${rec.studentId}</div>
                    <div class="flex-1">
                        <p class="font-bold text-sm">Siswa ${rec.studentId} <span class="text-[9px] px-2 py-0.5 rounded-full bg-slate-100 uppercase font-bold">${rec.status}</span></p>
                        <p class="text-[10px] text-slate-400">${rec.date}</p>
                        ${rec.reason ? `<p class="text-xs text-slate-500 italic mt-1">"${rec.reason}"</p>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        };

        document.getElementById('btnHistory').onclick = () => {
            const viewH = document.getElementById('viewHistory');
            const isH = !viewH.classList.contains('hidden');
            showView(isH ? 'grid' : 'history');
            document.getElementById('btnHistory').innerText = isH ? 'Riwayat' : 'Kembali';
        };

        document.getElementById('filterDate').onchange = renderHistory;
        document.getElementById('btnSave').onclick = saveToGithub;

        document.getElementById('filterDate').value = getRawToday();
        
        // PENTING: Panggil fetchData saat pertama kali buka
        fetchData();
        
        // Timer cadangan jika koneksi sangat lambat, paksa render nomor 1-34
        setTimeout(() => {
            if(document.getElementById('studentContainer').innerHTML === "") {
                renderGrid();
            }
            lucide.createIcons();
        }, 1000);
    </script>
</body>
</html>
